generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  timezone  String    @default("Asia/Karachi")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  projects  Project[]
  schedule  Schedule?
  teams     Team[]
  users     User[]

  @@map("organizations")
}

model User {
  id                 String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId              String           @map("org_id") @db.Uuid
  email              String           @unique @db.Citext
  passwordHash       String           @map("password_hash")
  fullName           String?          @map("full_name")
  role               UserRole
  isActive           Boolean          @default(true) @map("is_active")
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  teamId             String?          @map("team_id") @db.Uuid
  customCheckinStart String?          @map("custom_checkin_start")
  customCheckinEnd   String?          @map("custom_checkin_end")
  activitySamples    ActivitySample[]
  createdAdjustments Adjustment[]     @relation("CreatedByAdjustments")
  adjustments        Adjustment[]     @relation("UserAdjustments")
  deviceSessions     DeviceSession[]
  createdProjects    Project[]
  refreshTokens      RefreshToken[]
  assignedTasks      Task[]           @relation("AssignedTasks")
  createdTasks       Task[]           @relation("CreatedTasks")
  leadsTeam          Team[]           @relation("TeamLead")
  timeEntries        TimeEntry[]
  organization       Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  team               Team?            @relation("TeamMembers", fields: [teamId], references: [id])

  @@index([orgId])
  @@index([teamId])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model DeviceSession {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String           @map("user_id") @db.Uuid
  deviceId        String           @map("device_id")
  platform        String
  startedAt       DateTime         @map("started_at") @db.Timestamptz(6)
  endedAt         DateTime?        @map("ended_at") @db.Timestamptz(6)
  activitySamples ActivitySample[]
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId, startedAt])
  @@map("device_sessions")
}

model ActivitySample {
  id              BigInt         @id @default(autoincrement())
  userId          String         @map("user_id") @db.Uuid
  capturedAt      DateTime       @map("captured_at") @db.Timestamptz(6)
  mouseDelta      Int            @map("mouse_delta")
  keyCount        Int            @map("key_count")
  deviceSessionId String?        @map("device_session_id") @db.Uuid
  activeSeconds   Int?           @map("active_seconds")
  deviceSession   DeviceSession? @relation(fields: [deviceSessionId], references: [id])
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, capturedAt])
  @@map("activity_samples")
}

model TimeEntry {
  id        BigInt          @id @default(autoincrement())
  userId    String          @map("user_id") @db.Uuid
  startedAt DateTime        @map("started_at") @db.Timestamptz(6)
  endedAt   DateTime        @map("ended_at") @db.Timestamptz(6)
  kind      TimeEntryKind
  source    TimeEntrySource @default(AUTO)
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  projectId String?         @map("project_id") @db.Uuid
  taskId    String?         @map("task_id") @db.Uuid
  project   Project?        @relation(fields: [projectId], references: [id])
  task      Task?           @relation(fields: [taskId], references: [id])
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startedAt])
  @@index([projectId])
  @@index([taskId])
  @@map("time_entries")
}

model Schedule {
  orgId                String       @id @map("org_id") @db.Uuid
  tz                   String       @default("Asia/Karachi")
  checkinStart         String       @default("16:50") @map("checkin_start")
  checkinEnd           String       @default("02:00") @map("checkin_end")
  breakStart           String       @default("22:00") @map("break_start")
  breakEnd             String       @default("23:00") @map("break_end")
  idleThresholdSeconds Int          @default(300) @map("idle_threshold_seconds")
  organization         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("schedules")
}

model Adjustment {
  id            BigInt   @id @default(autoincrement())
  userId        String   @map("user_id") @db.Uuid
  createdBy     String   @map("created_by") @db.Uuid
  reason        String
  deltaMinutes  Int      @map("delta_minutes")
  effectiveDate DateTime @map("effective_date") @db.Date
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  creator       User     @relation("CreatedByAdjustments", fields: [createdBy], references: [id])
  user          User     @relation("UserAdjustments", fields: [userId], references: [id], onDelete: Cascade)

  @@map("adjustments")
}

model Team {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  orgId        String       @map("org_id") @db.Uuid
  leadId       String?      @map("lead_id") @db.Uuid
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  projects     Project[]
  lead         User?        @relation("TeamLead", fields: [leadId], references: [id])
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members      User[]       @relation("TeamMembers")

  @@index([orgId])
  @@index([leadId])
  @@map("teams")
}

model Project {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  description  String?
  color        String?       @default("#3B82F6")
  orgId        String        @map("org_id") @db.Uuid
  teamId       String?       @map("team_id") @db.Uuid
  status       ProjectStatus @default(ACTIVE)
  createdById  String        @map("created_by_id") @db.Uuid
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy    User          @relation(fields: [createdById], references: [id])
  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  team         Team?         @relation(fields: [teamId], references: [id])
  tasks        Task[]
  timeEntries  TimeEntry[]

  @@index([orgId])
  @@index([teamId])
  @@index([status])
  @@map("projects")
}

model Task {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  projectId   String      @map("project_id") @db.Uuid
  assignedTo  String?     @map("assigned_to") @db.Uuid
  createdById String      @map("created_by_id") @db.Uuid
  status      TaskStatus  @default(TODO)
  priority    Priority    @default(MEDIUM)
  dueDate     DateTime?   @map("due_date") @db.Timestamptz(6)
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  assignee    User?       @relation("AssignedTasks", fields: [assignedTo], references: [id])
  createdBy   User        @relation("CreatedTasks", fields: [createdById], references: [id])
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  timeEntries TimeEntry[]

  @@index([projectId])
  @@index([assignedTo])
  @@index([status])
  @@map("tasks")
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
}

enum TimeEntryKind {
  ACTIVE
  IDLE
  BREAK
}

enum TimeEntrySource {
  AUTO
  MANUAL
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
