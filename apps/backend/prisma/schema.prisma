generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  timezone  String   @default("Asia/Karachi")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  users     User[]
  schedule  Schedule?
  teams     Team[]
  projects  Project[]

  @@map("organizations")
}

model User {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId             String   @map("org_id") @db.Uuid
  email             String   @unique @db.Citext
  passwordHash      String   @map("password_hash")
  fullName          String?  @map("full_name")
  role              UserRole
  isActive          Boolean  @default(true) @map("is_active")
  screenshotEnabled Boolean  @default(true) @map("screenshot_enabled")
  teamId            String?  @map("team_id") @db.Uuid
  customCheckinStart String? @map("custom_checkin_start")
  customCheckinEnd   String? @map("custom_checkin_end")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz

  organization       Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  team               Team?             @relation("TeamMembers", fields: [teamId], references: [id], onDelete: SetNull)
  leadsTeam          Team[]            @relation("TeamLead")
  deviceSessions     DeviceSession[]
  activitySamples    ActivitySample[]
  timeEntries        TimeEntry[]
  adjustments        Adjustment[]      @relation("UserAdjustments")
  createdAdjustments Adjustment[]      @relation("CreatedByAdjustments")
  manualTimeRequests ManualTimeRequest[] @relation("UserManualTimeRequests")
  reviewedRequests   ManualTimeRequest[] @relation("ReviewedManualTimeRequests")
  refreshTokens      RefreshToken[]
  createdProjects    Project[]
  assignedTasks      Task[]            @relation("AssignedTasks")
  createdTasks       Task[]            @relation("CreatedTasks")
  screenshots        Screenshot[]

  @@index([orgId])
  @@index([teamId])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model DeviceSession {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  deviceId  String    @map("device_id")
  platform  String
  startedAt DateTime  @map("started_at") @db.Timestamptz
  endedAt   DateTime? @map("ended_at") @db.Timestamptz

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  activitySamples ActivitySample[]

  @@unique([userId, deviceId, startedAt])
  @@map("device_sessions")
}

model ActivitySample {
  id               BigInt    @id @default(autoincrement())
  userId           String    @map("user_id") @db.Uuid
  capturedAt       DateTime  @map("captured_at") @db.Timestamptz
  mouseDelta       Int       @map("mouse_delta")
  keyCount         Int       @map("key_count")
  activeSeconds    Int?      @map("active_seconds")
  deviceSessionId  String?   @map("device_session_id") @db.Uuid

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceSession DeviceSession? @relation(fields: [deviceSessionId], references: [id], onDelete: SetNull)

  @@index([userId, capturedAt])
  @@map("activity_samples")
}

model TimeEntry {
  id        BigInt          @id @default(autoincrement())
  userId    String          @map("user_id") @db.Uuid
  startedAt DateTime        @map("started_at") @db.Timestamptz
  endedAt   DateTime        @map("ended_at") @db.Timestamptz
  kind      TimeEntryKind
  source    TimeEntrySource @default(AUTO)
  projectId String?         @map("project_id") @db.Uuid
  taskId    String?         @map("task_id") @db.Uuid
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([userId, startedAt])
  @@index([projectId])
  @@index([taskId])
  @@map("time_entries")
}

model Schedule {
  orgId                 String @id @map("org_id") @db.Uuid
  tz                    String @default("Asia/Karachi")
  checkinStart          String @default("16:50") @map("checkin_start")
  checkinEnd            String @default("02:00") @map("checkin_end")
  breakStart            String @default("22:00") @map("break_start")
  breakEnd              String @default("23:00") @map("break_end")
  idleThresholdSeconds  Int    @default(300) @map("idle_threshold_seconds")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("schedules")
}

model Adjustment {
  id            BigInt   @id @default(autoincrement())
  userId        String   @map("user_id") @db.Uuid
  createdBy     String   @map("created_by") @db.Uuid
  reason        String
  deltaMinutes  Int      @map("delta_minutes")
  effectiveDate DateTime @map("effective_date") @db.Date
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  user    User @relation("UserAdjustments", fields: [userId], references: [id], onDelete: Cascade)
  creator User @relation("CreatedByAdjustments", fields: [createdBy], references: [id])

  @@map("adjustments")
}

model ManualTimeRequest {
  id            String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String                @map("user_id") @db.Uuid
  startTime     DateTime              @map("start_time") @db.Timestamptz
  endTime       DateTime              @map("end_time") @db.Timestamptz
  minutes       Int
  reason        String
  type          TimeEntryKind         @default(ACTIVE)
  status        ManualTimeStatus      @default(PENDING)
  reviewedBy    String?               @map("reviewed_by") @db.Uuid
  reviewedAt    DateTime?             @map("reviewed_at") @db.Timestamptz
  reviewNote    String?               @map("review_note")
  createdAt     DateTime              @default(now()) @map("created_at") @db.Timestamptz

  user      User  @relation("UserManualTimeRequests", fields: [userId], references: [id], onDelete: Cascade)
  reviewer  User? @relation("ReviewedManualTimeRequests", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([userId, status])
  @@index([status])
  @@map("manual_time_requests")
}

enum ManualTimeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
}

enum TimeEntryKind {
  ACTIVE
  IDLE
  BREAK
}

enum TimeEntrySource {
  AUTO
  MANUAL
}

model Team {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  orgId     String   @map("org_id") @db.Uuid
  leadId    String?  @map("lead_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  lead         User?        @relation("TeamLead", fields: [leadId], references: [id], onDelete: SetNull)
  members      User[]       @relation("TeamMembers")
  projects     Project[]

  @@index([orgId])
  @@index([leadId])
  @@map("teams")
}

model Project {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  color       String?       @default("#3B82F6")
  orgId       String        @map("org_id") @db.Uuid
  teamId      String?       @map("team_id") @db.Uuid
  status      ProjectStatus @default(ACTIVE)
  createdById String        @map("created_by_id") @db.Uuid
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  team         Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)
  createdBy    User         @relation(fields: [createdById], references: [id])
  tasks        Task[]
  timeEntries  TimeEntry[]

  @@index([orgId])
  @@index([teamId])
  @@index([status])
  @@map("projects")
}

model Task {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  projectId   String     @map("project_id") @db.Uuid
  assignedTo  String?    @map("assigned_to") @db.Uuid
  createdById String     @map("created_by_id") @db.Uuid
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?  @map("due_date") @db.Timestamptz
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee    User?       @relation("AssignedTasks", fields: [assignedTo], references: [id], onDelete: SetNull)
  createdBy   User        @relation("CreatedTasks", fields: [createdById], references: [id])
  timeEntries TimeEntry[]

  @@index([projectId])
  @@index([assignedTo])
  @@index([status])
  @@map("tasks")
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Screenshot {
  id         BigInt   @id @default(autoincrement())
  userId     String   @map("user_id") @db.Uuid
  fileUrl    String   @map("file_url")
  capturedAt DateTime @map("captured_at") @db.Timestamptz
  fileSize   Int      @map("file_size")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, capturedAt])
  @@map("screenshots")
}
